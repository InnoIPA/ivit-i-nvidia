FROM nvcr.io/nvidia/tensorrt:21.03-py3

USER root

ARG VER
ARG GITHUB_USER
ARG GITHUB_TOKEN

ENV IVIT=ivit-i-nvidia
ENV WS=/workspace
ENV DEBIAN_FRONTEND=noninteractive  
ENV REPO=https://github.com/InnoIPA/${IVIT}.git

# Download Repository
WORKDIR /opt/inno/${IVIT}
RUN apt-get update -q \
&& apt-get install -qqy git ssh openssh-server jq boxes \
&& git config --system credential.helper store \
&& echo "https://${GITHUB_USER}:${GITHUB_TOKEN}@github.com" > ~/.git-credentials \
&& git clone --recurse-submodules ${REPO} --branch ${VER} \
&& mv -f ${IVIT} ${WS}

# Install Relatived Package
WORKDIR ls && \
${WS}/docker/
RUN chmod u+x ./*.sh \
&& ./requirements.sh \
&& ./gen_inno_verify.sh \
&& mv ./inno_verify ./entrypoint /usr/bin

WORKDIR ${WS}
RUN echo -e "\n - Cythonize iVIT-I ... \n" \
&& chmod u+x ./*.sh \
&& ./cythonize.sh \
&& echo -e "\n - Remove Relatived Script  ... \n" \
&& rm -rf ./docker \
&& rm ./cythonize.sh \
&& rm -rf ./.git*

# Define Entrypoint
ENTRYPOINT [ "entrypoint" ]

# docker run -it --rm --privileged -v /dev:/dev --name ivit-i-intel-v0.8  --device /dev/dri --device-cgroup-rule='c 189:* rmw'  --net=host --ipc=host -v /etc/localtime:/etc/localtime:ro -v /tmp/.x11-unix:/tmp/.x11-unix:rw -e DISPLAY=unix:0 maxchanginnodisk/ivit-i-intel:v0.8 /workspace/init_samples.sh bash